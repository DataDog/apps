!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.DD_SDK=t():e.DD_SDK=t()}(window,(function(){return function(e){var t={};function i(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(n,s,function(t){return e[t]}.bind(null,s));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=2)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SDK_VERSION=t.UiAppEventType=t.UiAppCapabilityType=t.Host=void 0,function(e){e.PROD="https://app.datadoghq.com/",e.STAGE="https://dd.datad0g.com/"}(t.Host||(t.Host={})),function(e){e.APP_CONTEXT="app_context",e.DASHBOARD_COG_MENU="dashboard_cog_menu"}(t.UiAppCapabilityType||(t.UiAppCapabilityType={})),function(e){e.DASHBOARD_COG_MENU_CONTEXT="dashboard_cog_menu_context"}(t.UiAppEventType||(t.UiAppEventType={})),t.SDK_VERSION="0.1.0"},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getLogger=void 0,t.getLogger=e=>e.debug?{log:e=>console.log("dd-apps: "+e),error:e=>console.error("dd-apps: "+e)}:{log(){},error(){}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.init=void 0;const n=i(3);let s;t.init=(e,t)=>(s||(s=new n.DDClient(e)),t&&s.getContext().then(t),s)},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DDClient=void 0;const s=i(4),r=i(5),o=i(0),a=i(1),c={host:o.Host.STAGE,debug:!1};t.DDClient=class{constructor(e={}){this.host=e.host||c.host,this.debug=e.debug||c.debug,this.framePostClient=new s.ChildClient({debug:this.debug,profile:this.debug,context:{sdkVersion:o.SDK_VERSION}}),this.logger=a.getLogger(e),this.capabilityManagers=r.capabilityManagers.map(e=>new e({host:this.host,debug:this.debug},this.framePostClient)),this.capabilityManagers.forEach(e=>e.applyAdditionalMethods(this))}on(e,t){const i=this.getManagerByEventType(e);if(!i)return this.logger.error("Unknown event type"),()=>{};return this.framePostClient.on(e,(...s)=>n(this,void 0,void 0,(function*(){(yield i.isEnabled())?t(...s):this.logger.error(`The ${i.type} capability must be enabled to respond to events of type ${e}.`)})))}getContext(){return n(this,void 0,void 0,(function*(){return this.framePostClient.getContext()}))}getManagerByType(e){return this.capabilityManagers.find(t=>t.type===e)}getManagerByEventType(e){return this.capabilityManagers.find(t=>t.events.includes(e))}}},function(e,t,i){self,e.exports=(()=>{"use strict";var e={573:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ChildClient=void 0;const n=i(601),s=i(473),r=i(416);class o extends r.SharedClient{constructor(e={}){super(e),this.context=e.context||null,this.initListener=this.initListener.bind(this),window.addEventListener("message",this.initListener),this.profile&&this.onRequest(n.REQUEST_KEY_GET_PROFILE,()=>this.profiler.getEvents())}getLogger(){return s.getLogger("child-client",this.debug)}onChannelInit(e){window.removeEventListener("message",this.initListener),this.messagePort=e.ports[0];const t=this.getInitMessage(this.context);this.messagePort.postMessage(t),this.profiler.logEvent(n.ProfileEventType.POST_MESSAGE,t)}destroy(){this.messagePort&&this.messagePort.close(),window.removeEventListener("message",this.initListener)}}t.ChildClient=o},601:(e,t)=>{var i,n,s;Object.defineProperty(t,"__esModule",{value:!0}),t.REQUEST_KEY_GET_PROFILE=t.REQUEST_TIMEOUT=t.TransactionDirection=t.ProfileEventType=t.MessageAPIVersion=t.MessageType=void 0,(s=t.MessageType||(t.MessageType={})).CHANNEL_INIT="channel_init",s.EVENT="event",s.REQUEST="request",s.RESPONSE="response",(t.MessageAPIVersion||(t.MessageAPIVersion={})).v1="framepost/v1",(n=t.ProfileEventType||(t.ProfileEventType={})).POST_MESSAGE="post_message",n.RECEIVE_MESSAGE="receive_message",(i=t.TransactionDirection||(t.TransactionDirection={})).UP="up",i.DOWN="down",t.REQUEST_TIMEOUT=1e4,t.REQUEST_KEY_GET_PROFILE="framepost_get_profile"},607:function(e,t,i){var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||n(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),t.ParentClient=t.ChildClient=void 0;var r=i(573);Object.defineProperty(t,"ChildClient",{enumerable:!0,get:function(){return r.ChildClient}});var o=i(166);Object.defineProperty(t,"ParentClient",{enumerable:!0,get:function(){return o.ParentClient}}),s(i(699),t)},473:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getLogger=void 0,t.getLogger=(e,t)=>t?{log:t=>console.log(`${e}: ${t}`),error:t=>console.error(`${e}: ${t}`)}:{log(){},error(){}}},166:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ParentClient=void 0;const s=i(601),r=i(473),o=i(416),a=i(593);class c extends o.SharedClient{constructor(e={}){super(e)}requestChannel(e,t){if(this.url=new URL(e.src),e.contentWindow){const i=new MessageChannel;this.messagePort=i.port1;const n=this.getInitMessage(t);this.messagePort.onmessage=this.initListener.bind(this),e.contentWindow.postMessage(n,this.url.origin,[i.port2]),this.profiler.logEvent(s.ProfileEventType.POST_MESSAGE,n)}}getMessageProfile(){return n(this,void 0,void 0,(function*(){const e=yield this.request(s.REQUEST_KEY_GET_PROFILE),t=this.profiler.getEvents();return a.profileMessages(t,e)}))}onChannelInit(){}getLogger(){return r.getLogger("parent-client",this.debug)}destroy(){this.messagePort&&this.messagePort.close()}}t.ParentClient=c},819:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getProfiler=void 0,t.getProfiler=e=>{const t=[];return{logEvent(i,n){e&&t.push({type:i,message:n,date:new Date})},getEvents:()=>t}}},416:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SharedClient=void 0;const s=i(601),r=i(819),o=i(593);t.SharedClient=class{constructor({debug:e=!1,profile:t=!1,requestTimeout:i=s.REQUEST_TIMEOUT}={}){this.debug=e,this.profile=t,this.requestTimeout=i,this.channel=o.defer(),this.eventSubscriptions={},this.responseSubscriptions={},this.requestSubscriptions={},this.logger=this.getLogger(),this.profiler=r.getProfiler(t),this.channel.promise.then(()=>{this.logger.log("Secure parent <-> child channel established")})}send(e,t){return n(this,void 0,void 0,(function*(){return this.postMessage(s.MessageType.EVENT,e,t)}))}on(e,t){this.eventSubscriptions[e]||(this.eventSubscriptions[e]={});const i=o.randomInsecureId(8);return this.eventSubscriptions[e][i]=t,this.logger.log(`Registered handler for event "${e}"`),()=>{this.eventSubscriptions[e]=o.omit(this.eventSubscriptions[e],i),this.logger.log("Unsubscribed handler for event "+e)}}request(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.postMessage(s.MessageType.REQUEST,e,t),n=()=>{this.responseSubscriptions=o.omit(this.responseSubscriptions,i.id)};return new Promise((e,t)=>{let s;this.responseSubscriptions[i.id]=(t,i)=>{clearTimeout(s),n(),e(t)},s=setTimeout(()=>{n(),t("Request timed out")},this.requestTimeout)})}))}onRequest(e,t){return this.requestSubscriptions[e]=(i,r)=>n(this,void 0,void 0,(function*(){const n=yield t(i,r);this.postMessage(s.MessageType.RESPONSE,e,n,r.id)})),()=>{this.requestSubscriptions=o.omit(this.requestSubscriptions,e)}}getContext(){return n(this,void 0,void 0,(function*(){const{context:e}=yield this.channel.promise;return e}))}messageListener(e){return n(this,void 0,void 0,(function*(){if(yield this.channel.promise,this.isValidMessage(e)){switch(e.data.type){case s.MessageType.EVENT:this.handleEvent(e);break;case s.MessageType.REQUEST:this.handleRequest(e);break;case s.MessageType.RESPONSE:this.handleResponse(e)}this.profiler.logEvent(s.ProfileEventType.RECEIVE_MESSAGE,e.data)}else this.logger.error("Invalid message format. Skipping.")}))}handleEvent(e){const t=e.data,i=this.eventSubscriptions[t.key];i&&Object.values(i).forEach(e=>e(t.data,t))}handleRequest(e){const t=e.data,i=this.requestSubscriptions[t.key];i&&(i(t.data,t),this.logger.log("Handled request type "+t.key))}handleResponse(e){const t=e.data,i=t.requestId,n=i&&this.responseSubscriptions[i];n&&n(t.data,t)}postMessage(e,t,i,r){return n(this,void 0,void 0,(function*(){const{port:n}=yield this.channel.promise,a={type:e,apiVersion:s.MessageAPIVersion.v1,key:t,data:i,id:o.randomInsecureId(),requestId:r};return n.postMessage(a),this.profiler.logEvent(s.ProfileEventType.POST_MESSAGE,a),a}))}initListener(e){this.isInitMessage(e)?(this.profiler.logEvent(s.ProfileEventType.RECEIVE_MESSAGE,e.data),this.onChannelInit(e),this.messagePort&&(this.messagePort.onmessage=this.messageListener.bind(this)),this.resolveChannel(e)):this.logger.error("Invalid message format. Skipping.")}isValidMessage(e){const t=e.data;return t.type&&t.id&&t.apiVersion===s.MessageAPIVersion.v1}isInitMessage(e){return this.isValidMessage(e)&&e.data.type===s.MessageType.CHANNEL_INIT}resolveChannel(e){if(this.messagePort){const t={port:this.messagePort,origin:e.origin,context:e.data.data};this.channel.resolve(t)}}getInitMessage(e){return{type:s.MessageType.CHANNEL_INIT,apiVersion:s.MessageAPIVersion.v1,key:"",data:e,id:o.randomInsecureId()}}}},699:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},593:function(e,t,i){var n=this&&this.__rest||function(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(i[n[s]]=e[n[s]])}return i};Object.defineProperty(t,"__esModule",{value:!0}),t.profileMessages=t.omit=t.randomInsecureId=t.defer=void 0;const s=i(601);t.defer=()=>{let e=()=>{},t=()=>{};const i=new Promise((i,n)=>{e=i,t=n});return{resolve:e,reject:t,promise:i}},t.randomInsecureId=(e=16)=>[...Array(e)].map(()=>(~~(36*Math.random())).toString(36)).join(""),t.omit=(e,t)=>{const i=e,s=t;return i[s],n(i,["symbol"==typeof s?s:s+""])},t.profileMessages=(e,t)=>{const i=((e,t)=>{const i={};return e.forEach(e=>{i[(e=>e.message.id)(e)]=e}),i})(e.concat(t).filter(e=>e.type===s.ProfileEventType.RECEIVE_MESSAGE)),n=[],r=({date:e,message:t})=>{const n={id:t.id,direction:s.TransactionDirection.DOWN,postTime:e,message:t},r=i[t.id];return r&&(n.receiveTime=r.date,n.duration=(r.date.getTime()-e.getTime())/1e3),n};return e.filter(e=>e.type===s.ProfileEventType.POST_MESSAGE).forEach(e=>{const t=r(e);n.push(t)}),t.filter(e=>e.type===s.ProfileEventType.POST_MESSAGE).forEach(e=>{const t=r(e);t.direction=s.TransactionDirection.UP,n.push(t)}),n.filter(e=>e.message.key!==s.REQUEST_KEY_GET_PROFILE).sort((e,t)=>e.postTime.getTime()-t.postTime.getTime())}}},t={};return function i(n){if(t[n])return t[n].exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,i),s.exports}(607)})()},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.capabilityManagers=void 0;const n=i(0),s=i(6);class r extends s.CapabilityManager{constructor(){super(...arguments),this.type=n.UiAppCapabilityType.DASHBOARD_COG_MENU,this.events=[n.UiAppEventType.DASHBOARD_COG_MENU_CONTEXT]}getAdditionalClientMethods(){return{}}}t.capabilityManagers=[r]},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.CapabilityManager=void 0;const s=i(1);t.CapabilityManager=class{constructor(e,t){this.host=e.host,this.debug=e.debug,this.logger=s.getLogger(e),this.framePostClient=t}applyAdditionalMethods(e){const t=this.getAdditionalClientMethods(),i={};Object.entries(t).forEach(([e,t])=>{i[e]=(...e)=>n(this,void 0,void 0,(function*(){if(yield this.isEnabled())return t(...e);this.logger.error(`The ${this.type} capability must be enabled to perform this action`)}))}),Object.assign(e,i)}isEnabled(){return n(this,void 0,void 0,(function*(){const{capabilities:e}=yield this.framePostClient.getContext();return e.includes(this.type)}))}}}])}));
//# sourceMappingURL=main.js.map