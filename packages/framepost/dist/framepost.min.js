!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.framepost=t():e.framepost=t()}(window,(function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var s=t[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(i,s,function(t){return e[t]}.bind(null,s));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=4)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.REQUEST_KEY_GET_PROFILE=t.REQUEST_TIMEOUT=t.TransactionDirection=t.ProfileEventType=t.MessageAPIVersion=t.MessageType=void 0,function(e){e.CHANNEL_INIT="channel_init",e.EVENT="event",e.REQUEST="request",e.RESPONSE="response"}(t.MessageType||(t.MessageType={})),function(e){e.v1="framepost/v1"}(t.MessageAPIVersion||(t.MessageAPIVersion={})),function(e){e.POST_MESSAGE="post_message",e.RECEIVE_MESSAGE="receive_message"}(t.ProfileEventType||(t.ProfileEventType={})),function(e){e.UP="up",e.DOWN="down"}(t.TransactionDirection||(t.TransactionDirection={})),t.REQUEST_TIMEOUT=1e4,t.REQUEST_KEY_GET_PROFILE="framepost_get_profile"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getLogger=void 0,t.getLogger=(e,t)=>t?{log:t=>console.log(`${e}: ${t}`),error:t=>console.error(`${e}: ${t}`)}:{log(){},error(){}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(s,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SharedClient=void 0;const s=n(0),r=n(6),o=n(3);t.SharedClient=class{constructor({debug:e=!1,profile:t=!1}={}){this.debug=e,this.profile=t,this.channel=o.defer(),this.eventSubscriptions={},this.responseSubscriptions={},this.requestSubscriptions={},this.logger=this.getLogger(),this.profiler=r.getProfiler(t),this.messageListener=this.messageListener.bind(this),window.addEventListener("message",this.messageListener),this.logger.log("Client initialized. Listening for messages"),this.channel.promise.then(()=>{this.logger.log("Secure parent <-> child channel established")})}send(e,t){return i(this,void 0,void 0,(function*(){return this.postMessage(s.MessageType.EVENT,e,t)}))}on(e,t){this.eventSubscriptions[e]||(this.eventSubscriptions[e]={});const n=o.randomInsecureId(8);return this.eventSubscriptions[e][n]=t,this.logger.log(`Registered handler for event "${e}"`),()=>{this.eventSubscriptions[e]=o.omit(this.eventSubscriptions[e],n),this.logger.log("Unsubscribed handler for event "+e)}}request(e,t){return i(this,void 0,void 0,(function*(){const n=yield this.postMessage(s.MessageType.REQUEST,e,t),i=()=>{this.responseSubscriptions=o.omit(this.responseSubscriptions,n.id)};return new Promise((e,t)=>{let r;this.responseSubscriptions[n.id]=(t,n)=>{clearTimeout(r),i(),e(t)},r=setTimeout(()=>{i(),t("Request timed out")},s.REQUEST_TIMEOUT)})}))}onRequest(e,t){return this.requestSubscriptions[e]=(n,r)=>i(this,void 0,void 0,(function*(){const i=yield t(n,r);this.postMessage(s.MessageType.RESPONSE,e,i,r.id)})),()=>{this.requestSubscriptions=o.omit(this.requestSubscriptions,e)}}getContext(){return i(this,void 0,void 0,(function*(){const{context:e}=yield this.channel.promise;return e}))}destroy(){window.removeEventListener("message",this.messageListener)}messageListener(e){return i(this,void 0,void 0,(function*(){const t=this.isValidMessage(e);if(t&&e.data.type===s.MessageType.CHANNEL_INIT)return this.establishChannel(e),void this.profiler.logEvent(s.ProfileEventType.RECEIVE_MESSAGE,e.data);if(yield this.isFromSource(e))if(t){switch(e.data.type){case s.MessageType.EVENT:this.handleEvent(e);break;case s.MessageType.REQUEST:this.handleRequest(e);break;case s.MessageType.RESPONSE:this.handleResponse(e)}this.profiler.logEvent(s.ProfileEventType.RECEIVE_MESSAGE,e.data)}else this.logger.error("Invalid message format. Skipping.")}))}handleEvent(e){const t=e.data,n=this.eventSubscriptions[t.key];n&&Object.values(n).forEach(e=>e(t.data,t))}handleRequest(e){const t=e.data,n=this.requestSubscriptions[t.key];n&&(n(t.data,t),this.logger.log("Handled request type "+t.key))}handleResponse(e){const t=e.data,n=t.requestId,i=n&&this.responseSubscriptions[n];i&&i(t.data,t)}postMessage(e,t,n,r){return i(this,void 0,void 0,(function*(){const{source:i,origin:a}=yield this.channel.promise,c={type:e,apiVersion:s.MessageAPIVersion.v1,key:t,data:n,id:o.randomInsecureId(),requestId:r};return i.postMessage(c,a),this.profiler.logEvent(s.ProfileEventType.POST_MESSAGE,c),c}))}isFromSource(e){return i(this,void 0,void 0,(function*(){const{source:t}=yield this.channel.promise;return e.source===t}))}isValidMessage(e){const t=e.data;return t.type&&t.id&&t.apiVersion===s.MessageAPIVersion.v1}}},function(e,t,n){"use strict";var i=this&&this.__rest||function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(i=Object.getOwnPropertySymbols(e);s<i.length;s++)t.indexOf(i[s])<0&&Object.prototype.propertyIsEnumerable.call(e,i[s])&&(n[i[s]]=e[i[s]])}return n};Object.defineProperty(t,"__esModule",{value:!0}),t.profileMessages=t.omit=t.randomInsecureId=t.defer=void 0;const s=n(0);t.defer=()=>{let e=()=>{},t=()=>{};const n=new Promise((n,i)=>{e=n,t=i});return{resolve:e,reject:t,promise:n}},t.randomInsecureId=(e=16)=>[...Array(e)].map(()=>(~~(36*Math.random())).toString(36)).join(""),t.omit=(e,t)=>{const n=e,s=t;n[s];return i(n,["symbol"==typeof s?s:s+""])};t.profileMessages=(e,t)=>{const n=((e,t)=>{const n={};return e.forEach(e=>{n[t(e)]=e}),n})(e.concat(t).filter(e=>e.type===s.ProfileEventType.RECEIVE_MESSAGE),e=>e.message.id),i=[],r=({date:e,message:t})=>{const i={id:t.id,direction:s.TransactionDirection.DOWN,postTime:e,message:t},r=n[t.id];return r&&(i.receiveTime=r.date,i.duration=(r.date.getTime()-e.getTime())/1e3),i};return e.filter(e=>e.type===s.ProfileEventType.POST_MESSAGE).forEach(e=>{const t=r(e);i.push(t)}),t.filter(e=>e.type===s.ProfileEventType.POST_MESSAGE).forEach(e=>{const t=r(e);t.direction=s.TransactionDirection.UP,i.push(t)}),i.filter(e=>e.message.key!==s.REQUEST_KEY_GET_PROFILE).sort((e,t)=>e.postTime.getTime()-t.postTime.getTime())}},function(e,t,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),s=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||i(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.ParentClient=t.ChildClient=void 0;var r=n(5);Object.defineProperty(t,"ChildClient",{enumerable:!0,get:function(){return r.ChildClient}});var o=n(7);Object.defineProperty(t,"ParentClient",{enumerable:!0,get:function(){return o.ParentClient}}),s(n(8),t)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChildClient=void 0;const i=n(0),s=n(1),r=n(2);class o extends r.SharedClient{constructor(e){super(e),this.parentContext=e.parentContext||null,this.profile&&this.onRequest(i.REQUEST_KEY_GET_PROFILE,()=>this.profiler.getEvents())}getLogger(){return s.getLogger("child-client",this.debug)}establishChannel(e){const t={source:e.source,origin:e.origin,context:e.data.data};this.channel.resolve(t),this.postMessage(i.MessageType.CHANNEL_INIT,"",this.parentContext)}}t.ChildClient=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getProfiler=void 0,t.getProfiler=e=>{const t=[];return{logEvent(n,i){e&&t.push({type:n,message:i,date:new Date})},getEvents:()=>t}}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(s,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ParentClient=void 0;const s=n(0),r=n(1),o=n(2),a=n(3);class c extends o.SharedClient{constructor(e){super(e)}requestChannel(e,t){if(this.frame=e,this.url=new URL(e.src),e.contentWindow){const n={type:s.MessageType.CHANNEL_INIT,apiVersion:s.MessageAPIVersion.v1,key:"",data:t,id:a.randomInsecureId()};e.contentWindow.postMessage(n,this.url.origin),this.profiler.logEvent(s.ProfileEventType.POST_MESSAGE,n)}}getMessageProfile(){return i(this,void 0,void 0,(function*(){const e=yield this.request(s.REQUEST_KEY_GET_PROFILE),t=this.profiler.getEvents();return a.profileMessages(t,e)}))}establishChannel(e){if(this.frame&&e.source===this.frame.contentWindow){const t={source:e.source,origin:e.origin,context:e.data.data};this.channel.resolve(t)}}getLogger(){return r.getLogger("parent-client",this.debug)}}t.ParentClient=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0})}])}));
//# sourceMappingURL=framepost.min.js.map