!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.framepost=t():e.framepost=t()}(window,(function(){return function(e){var t={};function n(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(s,i,function(t){return e[t]}.bind(null,i));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=4)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EVENT_TYPE_GET_PROFILE=t.REQUEST_TIMEOUT=t.TransactionDirection=t.ProfileEventType=t.MessageAPIVersion=t.MessageType=void 0,function(e){e.CHANNEL_INIT="channel_init",e.EVENT="event",e.REQUEST="request",e.RESPONSE="response"}(t.MessageType||(t.MessageType={})),function(e){e.v1="framepost/v1"}(t.MessageAPIVersion||(t.MessageAPIVersion={})),function(e){e.POST_MESSAGE="post_message",e.RECEIVE_MESSAGE="receive_message"}(t.ProfileEventType||(t.ProfileEventType={})),function(e){e.UP="up",e.DOWN="down"}(t.TransactionDirection||(t.TransactionDirection={})),t.REQUEST_TIMEOUT=1e4,t.EVENT_TYPE_GET_PROFILE="framepost_get_profile"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getLogger=void 0,t.getLogger=(e,t)=>t?{log:t=>console.log(`${e}: ${t}`),error:t=>console.error(`${e}: ${t}`)}:{log(){},error(){}}},function(e,t,n){"use strict";var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(i,r){function o(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SharedClient=void 0;const i=n(0),r=n(6),o=n(3);t.SharedClient=class{constructor({debug:e=!1,profile:t=!1}={}){this.debug=e,this.profile=t,this.channel=o.defer(),this.eventSubscriptions={},this.responseSubscriptions={},this.requestSubscriptions={},this.logger=this.getLogger(),this.profiler=r.getProfiler(t),this.messageListener=this.messageListener.bind(this),window.addEventListener("message",this.messageListener),this.logger.log("Client initialized. Listening for messages"),this.channel.promise.then(()=>{this.logger.log("Secure parent <-> child channel established")})}send(e,t){return s(this,void 0,void 0,(function*(){return this.postMessage(i.MessageType.EVENT,e,t)}))}on(e,t){this.eventSubscriptions[e]||(this.eventSubscriptions[e]={});const n=o.randomInsecureId(8);return this.eventSubscriptions[e][n]=t,this.logger.log(`Registered handler for event "${e}"`),()=>{this.eventSubscriptions[e]=o.omit(this.eventSubscriptions[e],n),this.logger.log("Unsubscribed handler for event "+e)}}request(e,t){return s(this,void 0,void 0,(function*(){const n=yield this.postMessage(i.MessageType.REQUEST,e,t),s=()=>{this.responseSubscriptions=o.omit(this.responseSubscriptions,n.id)};return new Promise((e,t)=>{let r;this.responseSubscriptions[n.id]=(t,n)=>{clearTimeout(r),s(),e(t)},r=setTimeout(()=>{s(),t("Request timed out")},i.REQUEST_TIMEOUT)})}))}onRequest(e,t){return this.requestSubscriptions[e]=(n,r)=>s(this,void 0,void 0,(function*(){const s=yield t(n,r);this.postMessage(i.MessageType.RESPONSE,e,s,r.id)})),()=>{this.requestSubscriptions=o.omit(this.requestSubscriptions,e)}}getContext(){return s(this,void 0,void 0,(function*(){const{context:e}=yield this.channel.promise;return e}))}destroy(){window.removeEventListener("message",this.messageListener)}messageListener(e){return s(this,void 0,void 0,(function*(){if(!this.isValidMessage(e))return void this.logger.error("Invalid message format. Skipping");if(e.data.type===i.MessageType.CHANNEL_INIT)return void this.establishChannel(e);if(yield this.isFromValidSource(e)){switch(e.data.type){case i.MessageType.EVENT:this.handleEvent(e);break;case i.MessageType.REQUEST:this.handleRequest(e);break;case i.MessageType.RESPONSE:this.handleResponse(e)}this.profiler.logEvent(i.ProfileEventType.RECEIVE_MESSAGE,e.data)}else this.logger.error("Received message from invalid source. Skipping.")}))}handleEvent(e){const t=e.data,n=this.eventSubscriptions[t.key];n&&Object.values(n).forEach(e=>e(t.data,t))}handleRequest(e){const t=e.data,n=this.requestSubscriptions[t.key];n&&(n(t.data,t),this.logger.log("Handled request type "+t.key))}handleResponse(e){const t=e.data,n=t.requestId,s=n&&this.responseSubscriptions[n];s&&s(t.data,t)}postMessage(e,t,n,r){return s(this,void 0,void 0,(function*(){const{source:s,origin:a}=yield this.channel.promise,c={type:e,apiVersion:i.MessageAPIVersion.v1,key:t,data:n,id:o.randomInsecureId(),requestId:r};return s.postMessage(c,a),this.profiler.logEvent(i.ProfileEventType.POST_MESSAGE,c),c}))}isFromValidSource(e){return s(this,void 0,void 0,(function*(){const{source:t}=yield this.channel.promise;return e.source===t}))}isValidMessage(e){const t=e.data;return t.type&&t.id&&t.apiVersion===i.MessageAPIVersion.v1}}},function(e,t,n){"use strict";var s=this&&this.__rest||function(e,t){var n={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(s=Object.getOwnPropertySymbols(e);i<s.length;i++)t.indexOf(s[i])<0&&Object.prototype.propertyIsEnumerable.call(e,s[i])&&(n[s[i]]=e[s[i]])}return n};Object.defineProperty(t,"__esModule",{value:!0}),t.profileMessages=t.omit=t.randomInsecureId=t.defer=void 0;const i=n(0);t.defer=()=>{let e=()=>{},t=()=>{};const n=new Promise((n,s)=>{e=n,t=s});return{resolve:e,reject:t,promise:n}},t.randomInsecureId=(e=16)=>[...Array(e)].map(()=>(~~(36*Math.random())).toString(36)).join(""),t.omit=(e,t)=>{const n=e,i=t;n[i];return s(n,["symbol"==typeof i?i:i+""])};t.profileMessages=(e,t)=>{const n=((e,t)=>{const n={};return e.forEach(e=>{n[t(e)]=e}),n})(e.concat(t).filter(e=>e.type===i.ProfileEventType.RECEIVE_MESSAGE),e=>e.message.id),s=[],r=({date:e,message:t})=>{const s={id:t.id,direction:i.TransactionDirection.DOWN,postTime:e,message:t},r=n[t.id];return r&&(s.receiveTime=r.date,s.duration=(r.date.getTime()-e.getTime())/1e3),s};return e.filter(e=>e.type===i.ProfileEventType.POST_MESSAGE).forEach(e=>{const t=r(e);s.push(t)}),t.filter(e=>e.type===i.ProfileEventType.POST_MESSAGE).forEach(e=>{const t=r(e);t.direction=i.TransactionDirection.UP,s.push(t)}),s.sort((e,t)=>e.postTime.getTime()-t.postTime.getTime())}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ParentClient=t.ChildClient=void 0;var s=n(5);Object.defineProperty(t,"ChildClient",{enumerable:!0,get:function(){return s.ChildClient}});var i=n(7);Object.defineProperty(t,"ParentClient",{enumerable:!0,get:function(){return i.ParentClient}})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChildClient=void 0;const s=n(0),i=n(1),r=n(2);class o extends r.SharedClient{constructor(e){super(e),this.parentContext=e.parentContext||null,this.profile&&this.onRequest(s.EVENT_TYPE_GET_PROFILE,()=>this.profiler.getEvents())}getLogger(){return i.getLogger("child-client",this.debug)}establishChannel(e){const t={source:e.source,origin:e.origin,context:e.data.data};this.channel.resolve(t),this.postMessage(s.MessageType.CHANNEL_INIT,"",this.parentContext)}}t.ChildClient=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getProfiler=void 0,t.getProfiler=e=>{const t=[];return{logEvent(n,s){e&&t.push({type:n,message:s,date:new Date})},getEvents:()=>t}}},function(e,t,n){"use strict";var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(i,r){function o(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ParentClient=void 0;const i=n(0),r=n(1),o=n(2),a=n(3);class c extends o.SharedClient{constructor(e){super(e)}requestChannel(e,t){if(this.frame=e,this.url=new URL(e.src),e.contentWindow){const n={type:i.MessageType.CHANNEL_INIT,apiVersion:i.MessageAPIVersion.v1,key:"",data:t,id:a.randomInsecureId()};e.contentWindow.postMessage(n,"*"),this.profiler.logEvent(i.ProfileEventType.POST_MESSAGE,n)}}getMessageProfile(){return s(this,void 0,void 0,(function*(){const e=yield this.request(i.EVENT_TYPE_GET_PROFILE),t=this.profiler.getEvents();return a.profileMessages(t,e)}))}establishChannel(e){if(this.frame&&e.source===this.frame.contentWindow){const t={source:e.source,origin:e.origin,context:e.data.data};this.channel.resolve(t)}}getLogger(){return r.getLogger("parent-client",this.debug)}}t.ParentClient=c}])}));
//# sourceMappingURL=framepost.min.js.map