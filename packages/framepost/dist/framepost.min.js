!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.framepost=t():e.framepost=t()}(self,(function(){return(()=>{"use strict";var e={573:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ChildClient=void 0;const i=s(601),n=s(473),r=s(416);class o extends r.SharedClient{constructor(e={}){super(e),this.context=e.context||null,this.initListener=this.initListener.bind(this),window.addEventListener("message",this.initListener),this.profile&&this.onRequest(i.REQUEST_KEY_GET_PROFILE,(()=>this.profiler.getEvents()))}getLogger(){return n.getLogger("child-client",this.debug)}onChannelInit(e){window.removeEventListener("message",this.initListener),this.messagePort=e.ports[0];const t=this.getInitMessage(this.context);this.messagePort.postMessage(t),this.profiler.logEvent(i.ProfileEventType.POST_MESSAGE,t)}destroy(){this.messagePort&&this.messagePort.close(),window.removeEventListener("message",this.initListener)}}t.ChildClient=o},601:(e,t)=>{var s,i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.REQUEST_KEY_GET_PROFILE=t.REQUEST_TIMEOUT=t.TransactionDirection=t.ProfileEventType=t.MessageAPIVersion=t.MessageType=void 0,(n=t.MessageType||(t.MessageType={})).CHANNEL_INIT="channel_init",n.EVENT="event",n.REQUEST="request",n.RESPONSE="response",(t.MessageAPIVersion||(t.MessageAPIVersion={})).v1="framepost/v1",(i=t.ProfileEventType||(t.ProfileEventType={})).POST_MESSAGE="post_message",i.RECEIVE_MESSAGE="receive_message",(s=t.TransactionDirection||(t.TransactionDirection={})).UP="up",s.DOWN="down",t.REQUEST_TIMEOUT=1e4,t.REQUEST_KEY_GET_PROFILE="framepost_get_profile"},607:function(e,t,s){var i=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),n=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||i(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),t.ParentClient=t.ChildClient=void 0;var r=s(573);Object.defineProperty(t,"ChildClient",{enumerable:!0,get:function(){return r.ChildClient}});var o=s(166);Object.defineProperty(t,"ParentClient",{enumerable:!0,get:function(){return o.ParentClient}}),n(s(699),t)},473:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getLogger=void 0,t.getLogger=(e,t)=>t?{log:t=>console.log(`${e}: ${t}`),error:t=>console.error(`${e}: ${t}`)}:{log(){},error(){}}},166:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ParentClient=void 0;const n=s(601),r=s(473),o=s(416),a=s(593);class c extends o.SharedClient{constructor(e={}){super(e)}requestChannel(e,t){if(this.url=new URL(e.src),e.contentWindow){const s=new MessageChannel;this.messagePort=s.port1;const i=this.getInitMessage(t);this.messagePort.onmessage=this.initListener.bind(this),e.contentWindow.postMessage(i,this.url.origin,[s.port2]),this.profiler.logEvent(n.ProfileEventType.POST_MESSAGE,i)}}getMessageProfile(){return i(this,void 0,void 0,(function*(){const e=yield this.request(n.REQUEST_KEY_GET_PROFILE),t=this.profiler.getEvents();return a.profileMessages(t,e)}))}onChannelInit(){}getLogger(){return r.getLogger("parent-client",this.debug)}destroy(){this.messagePort&&this.messagePort.close()}}t.ParentClient=c},819:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getProfiler=void 0,t.getProfiler=e=>{const t=[];return{logEvent(s,i){e&&t.push({type:s,message:i,date:new Date})},getEvents:()=>t}}},416:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SharedClient=void 0;const n=s(601),r=s(819),o=s(593);t.SharedClient=class{constructor({debug:e=!1,profile:t=!1,requestTimeout:s=n.REQUEST_TIMEOUT}={}){this.debug=e,this.profile=t,this.requestTimeout=s,this.channel=o.defer(),this.eventSubscriptions={},this.responseSubscriptions={},this.requestSubscriptions={},this.logger=this.getLogger(),this.profiler=r.getProfiler(t),this.channel.promise.then((()=>{this.logger.log("Secure parent <-> child channel established")}))}send(e,t){return i(this,void 0,void 0,(function*(){return this.postMessage(n.MessageType.EVENT,e,t)}))}on(e,t){this.eventSubscriptions[e]||(this.eventSubscriptions[e]={});const s=o.randomInsecureId(8);return this.eventSubscriptions[e][s]=t,this.logger.log(`Registered handler for event "${e}"`),()=>{this.eventSubscriptions[e]=o.omit(this.eventSubscriptions[e],s),this.logger.log("Unsubscribed handler for event "+e)}}request(e,t){return i(this,void 0,void 0,(function*(){const s=yield this.postMessage(n.MessageType.REQUEST,e,t),i=()=>{this.responseSubscriptions=o.omit(this.responseSubscriptions,s.id)};return new Promise(((e,t)=>{let n;this.responseSubscriptions[s.id]=(t,s)=>{clearTimeout(n),i(),e(t)},n=setTimeout((()=>{i(),t("Request timed out")}),this.requestTimeout)}))}))}onRequest(e,t){return this.requestSubscriptions[e]=(s,r)=>i(this,void 0,void 0,(function*(){const i=yield t(s,r);this.postMessage(n.MessageType.RESPONSE,e,i,r.id)})),()=>{this.requestSubscriptions=o.omit(this.requestSubscriptions,e)}}getContext(){return i(this,void 0,void 0,(function*(){const{context:e}=yield this.channel.promise;return e}))}messageListener(e){return i(this,void 0,void 0,(function*(){if(yield this.channel.promise,this.isValidMessage(e)){switch(e.data.type){case n.MessageType.EVENT:this.handleEvent(e);break;case n.MessageType.REQUEST:this.handleRequest(e);break;case n.MessageType.RESPONSE:this.handleResponse(e)}this.profiler.logEvent(n.ProfileEventType.RECEIVE_MESSAGE,e.data)}else this.logger.error("Invalid message format. Skipping.")}))}handleEvent(e){const t=e.data,s=this.eventSubscriptions[t.key];s&&Object.values(s).forEach((e=>e(t.data,t)))}handleRequest(e){const t=e.data,s=this.requestSubscriptions[t.key];s&&(s(t.data,t),this.logger.log("Handled request type "+t.key))}handleResponse(e){const t=e.data,s=t.requestId,i=s&&this.responseSubscriptions[s];i&&i(t.data,t)}postMessage(e,t,s,r){return i(this,void 0,void 0,(function*(){const{port:i}=yield this.channel.promise,a={type:e,apiVersion:n.MessageAPIVersion.v1,key:t,data:s,id:o.randomInsecureId(),requestId:r};return i.postMessage(a),this.profiler.logEvent(n.ProfileEventType.POST_MESSAGE,a),a}))}initListener(e){this.isInitMessage(e)?(this.profiler.logEvent(n.ProfileEventType.RECEIVE_MESSAGE,e.data),this.onChannelInit(e),this.messagePort&&(this.messagePort.onmessage=this.messageListener.bind(this)),this.resolveChannel(e)):this.logger.error("Invalid message format. Skipping.")}isValidMessage(e){const t=e.data;return t.type&&t.id&&t.apiVersion===n.MessageAPIVersion.v1}isInitMessage(e){return this.isValidMessage(e)&&e.data.type===n.MessageType.CHANNEL_INIT}resolveChannel(e){if(this.messagePort){const t={port:this.messagePort,origin:e.origin,context:e.data.data};this.channel.resolve(t)}}getInitMessage(e){return{type:n.MessageType.CHANNEL_INIT,apiVersion:n.MessageAPIVersion.v1,key:"",data:e,id:o.randomInsecureId()}}}},699:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},593:function(e,t,s){var i=this&&this.__rest||function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(s[i[n]]=e[i[n]])}return s};Object.defineProperty(t,"__esModule",{value:!0}),t.profileMessages=t.omit=t.randomInsecureId=t.defer=void 0;const n=s(601);t.defer=()=>{let e=()=>{},t=()=>{};const s=new Promise(((s,i)=>{e=s,t=i}));return{resolve:e,reject:t,promise:s}},t.randomInsecureId=(e=16)=>[...Array(e)].map((()=>(~~(36*Math.random())).toString(36))).join(""),t.omit=(e,t)=>{const s=e,n=t;return s[n],i(s,["symbol"==typeof n?n:n+""])},t.profileMessages=(e,t)=>{const s=((e,t)=>{const s={};return e.forEach((e=>{s[(e=>e.message.id)(e)]=e})),s})(e.concat(t).filter((e=>e.type===n.ProfileEventType.RECEIVE_MESSAGE))),i=[],r=({date:e,message:t})=>{const i={id:t.id,direction:n.TransactionDirection.DOWN,postTime:e,message:t},r=s[t.id];return r&&(i.receiveTime=r.date,i.duration=(r.date.getTime()-e.getTime())/1e3),i};return e.filter((e=>e.type===n.ProfileEventType.POST_MESSAGE)).forEach((e=>{const t=r(e);i.push(t)})),t.filter((e=>e.type===n.ProfileEventType.POST_MESSAGE)).forEach((e=>{const t=r(e);t.direction=n.TransactionDirection.UP,i.push(t)})),i.filter((e=>e.message.key!==n.REQUEST_KEY_GET_PROFILE)).sort(((e,t)=>e.postTime.getTime()-t.postTime.getTime()))}}},t={};return function s(i){if(t[i])return t[i].exports;var n=t[i]={exports:{}};return e[i].call(n.exports,n,n.exports,s),n.exports}(607)})()}));
//# sourceMappingURL=framepost.min.js.map